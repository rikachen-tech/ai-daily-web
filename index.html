<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-AI Insights - 订阅中心</title>
    <!-- 引入样式和库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入 Firebase 兼容版 SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: black; }
        .glass-card { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(39, 39, 42, 1); }
    </style>
</head>
<body class="text-white">
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. 填入您的专属 Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyCRi5GAPSMicNMEyiEFibOMRZu8ldpa4i8",
            authDomain: "my-ai-daily.firebaseapp.com",
            projectId: "my-ai-daily",
            storageBucket: "my-ai-daily.firebasestorage.app",
            messagingSenderId: "818838941572",
            appId: "1:818838941572:web:a2b3b807b72798f562f7d1",
            measurementId: "G-NT88GKS05E"
        };

        // 初始化
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = "ai-daily-app";

        const { useState, useEffect } = React;

        // 图标组件
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{width: size, height: size}} className={className}></i>;
        };

        function App() {
            const [email, setEmail] = useState('');
            const [otp, setOtp] = useState('');
            const [view, setView] = useState('subscribe'); 
            const [status, setStatus] = useState('idle'); 
            const [message, setMessage] = useState('');
            const [errorCode, setErrorCode] = useState('');

            useEffect(() => {
                auth.signInAnonymously().catch(err => setErrorCode(err.code));
            }, []);

            const handleSendCode = async (e) => {
                e.preventDefault();
                if (!email || !email.includes('@')) {
                    setStatus('error');
                    setMessage('请输入有效的邮箱地址');
                    return;
                }
                setStatus('loading');
                try {
                    const code = Math.floor(100000 + Math.random() * 900000).toString();
                    // 写入验证请求
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('verification_requests').add({
                        email: email.trim().toLowerCase(),
                        code: code,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    localStorage.setItem('temp_otp', code);
                    localStorage.setItem('temp_email', email.trim().toLowerCase());
                    setView('verify');
                    setStatus('idle');
                    setMessage('验证码请求已提交！请检查邮箱。');
                } catch (err) {
                    console.error(err);
                    setStatus('error');
                    setErrorCode(err.code);
                    setMessage('连接失败，请确保 Firebase Rules 已正确发布。');
                }
            };

            const handleVerify = async (e) => {
                e.preventDefault();
                const savedCode = localStorage.getItem('temp_otp');
                const savedEmail = localStorage.getItem('temp_email');
                if (otp !== savedCode) {
                    setStatus('error');
                    setMessage('验证码不正确');
                    return;
                }
                setStatus('loading');
                try {
                    const subsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('subscribers');
                    const snapshot = await subsRef.where('email', '==', savedEmail).get();
                    if (snapshot.empty) {
                        await subsRef.add({ 
                            email: savedEmail, 
                            active: true, 
                            subscribedAt: firebase.firestore.FieldValue.serverTimestamp() 
                        });
                    } else {
                        await snapshot.docs[0].ref.update({ active: true });
                    }
                    setStatus('success');
                    setMessage('验证成功！您已正式加入订阅。');
                    setView('subscribe');
                    setEmail('');
                    setOtp('');
                } catch (err) {
                    setStatus('error');
                    setErrorCode(err.code);
                    setMessage('保存失败，请检查数据库权限。');
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6">
                    {/* Logo 区域 */}
                    <div className="absolute top-10 flex items-center space-x-2 text-blue-400">
                        <Icon name="twitter" size={32} className="fill-current" />
                        <span className="text-xl font-black tracking-tighter italic">X-AI INSIGHTS</span>
                    </div>

                    {/* 主卡片 */}
                    <main className="w-full max-w-md glass-card p-8 rounded-[2.5rem] shadow-2xl">
                        {view === 'subscribe' ? (
                            <div className="text-center">
                                <div className="flex items-center justify-center space-x-2 mb-4 text-yellow-500">
                                    <Icon name="sparkles" size={16} />
                                    <span className="text-[10px] font-black uppercase tracking-[0.3em]">AI Intelligence</span>
                                </div>
                                <h1 className="text-3xl font-black mb-3 text-white leading-tight">掌握 AI 进化脉络</h1>
                                <p className="text-zinc-500 mb-8 text-sm leading-relaxed px-4 text-center">
                                    聚合全球 AI 领袖动态。由 PM 视角深度拆解商业逻辑。每日 09:00 送达。
                                </p>
                                
                                <form onSubmit={handleSendCode} className="space-y-4">
                                    <div className="relative group">
                                        <Icon name="mail" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-600 group-focus-within:text-blue-500 transition-colors" />
                                        <input
                                            type="email"
                                            placeholder="输入邮箱开启推送"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full bg-black border border-zinc-800 rounded-2xl py-4 pl-12 pr-4 outline-none focus:border-blue-500 text-white placeholder:text-zinc-700 transition-all"
                                        />
                                    </div>
                                    <button type="submit" className="w-full bg-white text-black font-black py-4 rounded-2xl hover:bg-blue-400 hover:text-white transition-all transform active:scale-95">
                                        {status === 'loading' ? '正在连接...' : '获取验证码'}
                                    </button>
                                </form>
                            </div>
                        ) : (
                            <div className="text-center">
                                <div className="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Icon name="key" size={24} className="text-blue-500" />
                                </div>
                                <h1 className="text-2xl font-black mb-2 text-white text-center">确认验证码</h1>
                                <p className="text-zinc-500 mb-8 text-xs text-center">验证码已发送至 <b>{email}</b></p>
                                <form onSubmit={handleVerify} className="space-y-4">
                                    <input
                                        type="text"
                                        placeholder="000000"
                                        maxLength="6"
                                        value={otp}
                                        onChange={(e) => setOtp(e.target.value)}
                                        className="w-full bg-black border border-zinc-800 rounded-2xl py-5 text-center text-3xl tracking-[0.6em] font-mono outline-none focus:border-blue-500 text-white"
                                    />
                                    <button type="submit" className="w-full bg-blue-600 text-white font-black py-4 rounded-2xl hover:bg-blue-500 transition-all">
                                        确认激活订阅
                                    </button>
                                    <button type="button" onClick={() => setView('subscribe')} className="text-zinc-600 text-xs hover:text-zinc-400 transition-colors">返回修改邮箱</button>
                                </form>
                            </div>
                        )}

                        {/* 消息提示 */}
                        {message && (
                            <div className={`mt-8 p-4 rounded-2xl text-[11px] font-medium flex items-start space-x-2 border animate-in fade-in slide-in-from-bottom-2 ${
                                status === 'success' ? 'bg-green-500/5 border-green-500/20 text-green-400' : 'bg-red-500/5 border-red-500/20 text-red-400'
                            }`}>
                                <Icon name={status === 'success' ? 'check-circle' : 'alert-circle'} size={14} className="mt-0.5 shrink-0" />
                                <span>{message} {errorCode && `[Error: ${errorCode}]`}</span>
                            </div>
                        )}
                    </main>

                    <p className="mt-10 text-[10px] text-zinc-600 uppercase tracking-widest font-bold opacity-40">
                        Stay ahead of the curve with X-AI
                    </p>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
